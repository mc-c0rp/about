<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin // System Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <style>
        :root {
            --font-family-mono: 'Source Code Pro', monospace;
            --bg-page: #1F1F1F;
            --bg-sidebar: #252525;
            --bg-card: #2B2B2B;
            --text-primary: #F0F0F0;
            --text-secondary: #888888;
            --border-color: #3C3C3C;
            --accent-color: #D8D8D8;
            --success-color: #28a745;
            --warning-color: #ff9800;
            --danger-color: #dc3545;
            --chip-bg: #444444;
            --border-radius: 8px;
            --scrollbar-track: #252525;
            --scrollbar-thumb: #444444;
            --selection-bg: #555555;
            --selection-text: #ffffff;
        }

        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family-mono);
            margin: 0;
            background-color: var(--bg-page);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
        ::selection { background-color: var(--selection-bg); color: var(--selection-text); }

        /* Sidebar */
        aside {
            width: 250px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav-list {
            list-style: none;
            padding: 10px;
            margin: 0;
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover { background-color: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); font-weight: 600; }

        /* Main Area */
        main { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow: hidden; }

        .header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;
        }
        .page-title { margin: 0; font-size: 24px; }
        
        .server-controls { display: flex; gap: 10px; }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { border-color: var(--accent-color); transform: translateY(-1px); }
        
        /* Specific Buttons */
        .btn-danger { color: var(--danger-color); border-color: var(--danger-color); background: transparent; }
        .btn-danger:hover { background: var(--danger-color); color: white; }
        
        .btn-warning { color: var(--warning-color); border-color: var(--warning-color); background: transparent; }
        .btn-warning:hover { background: var(--warning-color); color: #000; }
        
        .btn-save { background: var(--text-primary); color: var(--bg-page); border-color: var(--text-primary); }
        
        .btn-toggle { color: var(--text-secondary); }
        .btn-toggle.active { color: var(--success-color); border-color: var(--success-color); background: rgba(40, 167, 69, 0.1); }

        /* Views */
        .view-container { flex: 1; display: none; flex-direction: column; min-height: 0; }
        .view-container.active { display: flex; }

        /* Users Grid */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .user-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-header { display: flex; justify-content: space-between; align-items: center; }
        .user-id { font-weight: 600; font-size: 16px; }
        .status-badge { 
            width: 10px; height: 10px; border-radius: 50%; display: inline-block; 
        }
        .status-online { background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .status-offline { background-color: var(--text-secondary); }
        .last-seen { font-size: 12px; color: var(--text-secondary); }

        /* Files Split View */
        .split-wrapper { display: flex; flex: 1; gap: 20px; min-height: 0; }
        
        .file-list {
            width: 250px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow-y: auto;
            display: flex; flex-direction: column;
        }

        .file-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .file-item:hover { background: var(--bg-sidebar); }
        .file-item.active { background: var(--bg-sidebar); border-left: 3px solid var(--text-primary); }
        .file-ext { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--chip-bg); }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }

        .editor-toolbar {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-sidebar);
            height: 50px;
        }
        
        .toolbar-right { display: flex; align-items: center; gap: 10px; }
        
        .readonly-badge {
            font-size: 11px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
        }
        .readonly-badge.show { display: inline-block; }

        textarea.code-editor {
            flex: 1;
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 20px;
            font-family: var(--font-family-mono);
            font-size: 14px;
            resize: none;
            outline: none;
            line-height: 1.5;
            white-space: pre;
        }
        
        textarea.code-editor[readonly] {
            opacity: 0.7;
            cursor: default;
        }

        .empty-state {
            display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);
            text-align: center;
        }

        #notification {
            position: fixed; bottom: 20px; right: 20px; padding: 15px 25px;
            background-color: var(--success-color); color: white; border-radius: var(--border-radius);
            transform: translateY(100px); transition: 0.3s; z-index: 2000;
        }
        #notification.error { background-color: var(--danger-color); }
        #notification.show { transform: translateY(0); }

    </style>
</head>

<body>

    <aside>
        <div class="sidebar-header">
            SYSTEM CONTROL
        </div>
        <ul class="nav-list">
            <li class="nav-item active" onclick="switchView('users')">
                <span>üë• Users Status</span>
            </li>
            <li class="nav-item" onclick="switchView('files')">
                <span>üìÇ System Files</span>
            </li>
        </ul>
    </aside>

    <main>
        <div class="header-row">
            <h2 class="page-title" id="pageTitle">Users Monitor</h2>
            <div class="server-controls">
                <button class="btn btn-warning" onclick="serverAction('restart')">‚Üª Restart</button>
                <button class="btn btn-danger" onclick="serverAction('kill')">‚ò† Kill</button>
            </div>
        </div>

        <div id="view-users" class="view-container active">
            <div class="header-row" style="margin-bottom: 10px;">
                <span class="last-seen" id="lastUpdatedUsers">Waiting for update...</span>
                <div style="display: flex; gap: 10px;">
                    <button id="btnAutoRefresh" class="btn btn-toggle" onclick="toggleAutoRefresh()">
                        <span id="autoRefreshIcon">‚óã</span> Auto Refresh
                    </button>
                    <button class="btn" onclick="loadUsers()">Refresh Now</button>
                </div>
            </div>
            <div class="users-grid" id="usersGrid">
                <div class="empty-state">Loading users...</div>
            </div>
        </div>

        <div id="view-files" class="view-container">
            <div class="split-wrapper">
                <div class="file-list" id="fileList">
                    </div>
                <div class="editor-pane">
                    <div class="editor-toolbar">
                        <span id="currentFileName" style="font-weight: 600;">No file selected</span>
                        <div class="toolbar-right">
                            <span id="readOnlyBadge" class="readonly-badge">READ ONLY</span>
                            <button class="btn btn-save" id="btnSaveFile" onclick="saveCurrentFile()" style="display: none;">Save JSON</button>
                        </div>
                    </div>
                    <textarea id="jsonEditor" class="code-editor" spellcheck="false" placeholder="Select a file..."></textarea>
                    <div id="editorEmpty" class="empty-state">Select a file from the list.</div>
                </div>
            </div>
        </div>
    </main>

    <div id="notification">Notification</div>

    <script>
        // Global State
        let currentView = 'users';
        let currentFile = null;
        let autoRefreshTimer = null;

        // --- Navigation ---
        function switchView(viewName) {
            currentView = viewName;
            
            // UI Toggle
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            
            if(viewName === 'users') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
                document.getElementById('view-users').classList.add('active');
                document.getElementById('pageTitle').innerText = "Users Monitor";
                loadUsers();
            } else {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                document.getElementById('view-files').classList.add('active');
                document.getElementById('pageTitle').innerText = "System Files";
                loadFiles();
                // Turn off auto refresh if leaving users tab
                if(autoRefreshTimer) toggleAutoRefresh();
            }
        }

        // --- Users Logic & Auto Refresh ---
        function toggleAutoRefresh() {
            const btn = document.getElementById('btnAutoRefresh');
            const icon = document.getElementById('autoRefreshIcon');
            
            if (autoRefreshTimer) {
                // Turn OFF
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                btn.classList.remove('active');
                icon.innerText = "‚óã";
            } else {
                // Turn ON
                loadUsers(); // Load once immediately
                autoRefreshTimer = setInterval(loadUsers, 2000); // Refresh every 2 seconds
                btn.classList.add('active');
                icon.innerText = "‚óè";
            }
        }

        async function loadUsers() {
            const grid = document.getElementById('usersGrid');
            try {
                const res = await fetch('/users/status');
                const users = await res.json();
                
                if(users.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No active users recorded.</div>';
                } else {
                    grid.innerHTML = '';
                    users.forEach(user => {
                        const date = new Date(user.last_seen);
                        const timeStr = date.toLocaleTimeString();
                        const statusClass = user.online ? 'status-online' : 'status-offline';
                        
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <div class="user-header">
                                <span class="user-id">ID: ${user.user_id}</span>
                                <span class="status-badge ${statusClass}"></span>
                            </div>
                            <div class="last-seen">Last Seen: ${timeStr}</div>
                            <div style="font-size:12px; margin-top:5px; color:${user.online ? 'var(--success-color)' : 'var(--text-secondary)'}">
                                ${user.online ? 'ONLINE' : 'OFFLINE'}
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }
                
                document.getElementById('lastUpdatedUsers').innerText = `Updated: ${new Date().toLocaleTimeString()}`;

            } catch (e) {
                // Don't spam errors in auto-refresh mode
                if(!autoRefreshTimer) showNotif("Error loading users", true);
                document.getElementById('lastUpdatedUsers').innerText = "Connection Error";
            }
        }

        // --- Files Logic ---
        async function loadFiles() {
            const list = document.getElementById('fileList');
            // Don't wipe list if we are just switching back, unless empty
            if(list.children.length === 0) list.innerHTML = '<div style="padding:10px; color:#888;">Loading...</div>';
            
            try {
                const res = await fetch('/system-files');
                const data = await res.json();
                
                list.innerHTML = '';
                const info = document.createElement('div');
                info.style.padding = "10px";
                info.style.fontSize = "11px";
                info.style.color = "var(--text-secondary)";
                info.style.borderBottom = "1px solid var(--border-color)";
                info.innerText = `DIR: ${data.directory}`;
                list.appendChild(info);

                data.files.forEach(filename => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    const ext = filename.split('.').pop();
                    
                    div.innerHTML = `
                        <span>${filename}</span>
                        <span class="file-ext">${ext.toUpperCase()}</span>
                    `;
                    div.onclick = () => openFile(filename, div);
                    list.appendChild(div);
                });

            } catch (e) {
                showNotif("Error loading file list", true);
            }
        }

        async function openFile(filename, element) {
            // UI Selection
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            const editor = document.getElementById('jsonEditor');
            const emptyState = document.getElementById('editorEmpty');
            const saveBtn = document.getElementById('btnSaveFile');
            const label = document.getElementById('currentFileName');
            const badge = document.getElementById('readOnlyBadge');

            label.innerText = filename;
            editor.style.display = 'block';
            emptyState.style.display = 'none';
            editor.value = "Loading...";

            const isJson = filename.endsWith('.json');
            
            // Toggle Read-Only State
            if (isJson) {
                editor.readOnly = false;
                saveBtn.style.display = 'block';
                badge.classList.remove('show');
                saveBtn.disabled = true; // Disable until loaded
            } else {
                editor.readOnly = true;
                saveBtn.style.display = 'none';
                badge.classList.add('show');
            }
            
            currentFile = filename;

            // Fetch Logic
            try {
                // NOTE: Assumes backend has /read/<filename> for raw text OR /json/ supports text
                // Adjust route based on your backend implementation
                const route = isJson ? `/json/${filename}` : `/json/${filename}`;
                
                const res = await fetch(route);
                if (!res.ok) {
                    if(res.status === 400 && !isJson) throw new Error("Backend blocked .txt (Update backend)");
                    throw new Error("Failed to load");
                }
                
                let content;
                if (isJson) {
                    const json = await res.json();
                    content = JSON.stringify(json, null, 4);
                } else {
                    content = await res.text();
                }

                editor.value = content;
                if (isJson) saveBtn.disabled = false;

            } catch (e) {
                editor.value = `Error reading file:\n${e.message}`;
                showNotif("Cannot read file", true);
            }
        }

        async function saveCurrentFile() {
            if (!currentFile || !currentFile.endsWith('.json')) return;

            const editor = document.getElementById('jsonEditor');
            const content = editor.value;

            // Validate JSON
            let parsed;
            try {
                parsed = JSON.parse(content);
            } catch (e) {
                showNotif("Invalid JSON! Cannot save.", true);
                return;
            }

            try {
                const res = await fetch(`/json/${currentFile}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsed)
                });

                const result = await res.json();
                if (res.ok) {
                    showNotif(`File ${currentFile} saved!`);
                    editor.value = JSON.stringify(parsed, null, 4); // Reformat
                } else {
                    showNotif("Error: " + (result.error || "Unknown"), true);
                }
            } catch (e) {
                showNotif("Network error", true);
            }
        }

        // --- Server Actions ---
        function serverAction(action) {
            const msg = action === 'restart' 
                ? "Confirm Server RESTART?"
                : "DANGER: Confirm KILL Server process?";
            
            if (!confirm(msg)) return;

            fetch(`/${action}`)
                .then(res => res.text())
                .then(text => {
                    showNotif(`Sent: ${text}`);
                })
                .catch(err => {
                    showNotif("Error sending command", true);
                });
        }

        // --- Utils ---
        function showNotif(msg, isError = false) {
            const n = document.getElementById('notification');
            n.innerText = msg;
            n.className = isError ? 'error' : '';
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // Tab support
        document.getElementById('jsonEditor').addEventListener('keydown', function(e) {
            if (e.key == 'Tab' && !this.readOnly) {
                e.preventDefault();
                var start = this.selectionStart;
                var end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            }
        });

        loadUsers();
    </script>
</body>
</html>